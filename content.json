{"meta":{"title":"Dayn'Night","subtitle":"深夜便利店","description":"买点什么好呢？","author":"Sconosciuti","url":"http://daynnight.io"},"pages":[{"title":"","date":"2018-08-17T13:58:47.000Z","updated":"2018-08-17T09:59:16.915Z","comments":false,"path":"tags/index.html","permalink":"http://daynnight.io/tags/index.html","excerpt":"","text":""},{"title":"categories","date":"2018-08-17T14:02:04.000Z","updated":"2018-08-17T10:02:29.933Z","comments":false,"path":"categories/index.html","permalink":"http://daynnight.io/categories/index.html","excerpt":"","text":""}],"posts":[{"title":"RouterOS基于目标地址的国内外分流","slug":"RouterOS基于目标地址的国内外分流","date":"2018-08-21T08:59:06.000Z","updated":"2018-08-21T05:00:00.355Z","comments":true,"path":"posts/536e8593/","link":"","permalink":"http://daynnight.io/posts/536e8593/","excerpt":"","text":"前期准备硬件 Mikrotik 路由器 × 1 –&gt; 请配置完能上网之后直接阅读RouterOS 配置部分 或 RouterOS 虚拟机 × 1 –&gt; 请完整阅读 软件 可用的 L2TP / PPTP / SSTP 账号 × 1 【可选】Winbox 点此下载 v3.17 (Windows 平台，用于登录并管理 RouterOS。macOS 和 Linux 需要使用 Wine 或虚拟机) 推荐 L2TP over IPSec。 RouterOS 安装本地VMWare / VMWare ESXi: https://wiki.mikrotik.com/wiki/Manual:CHR_VMWare_installation Hyper-V: https://wiki.mikrotik.com/wiki/Manual:CHR_Hyper-V_installation VirtualBox: https://wiki.mikrotik.com/wiki/Manual:CHR_VirtualBox_installation ProxMox: https://wiki.mikrotik.com/wiki/Manual:CHR_ProxMox_installation 云安装脚本功能 设置默认网关、路由（如果接口名称非 eth0 请手动更改脚本第 4 行） 更改默认用户名及密码防止被空密码登录 禁用 Telnet、FTP 及 API 端口 更改 SSH 默认端口 设置 DNS 服务器为 1.1.1.1 设置 NAT 规则 设定时区及 NTP 对时（使用 ntp1.aliyun.com及 ntp2.aliyun.com，值需为 IP 形式） 12345678910111213141516171819wget https://download2.mikrotik.com/routeros/6.42.7/chr-6.42.7.img.zip -O chr.img.zip &amp;&amp; \\gunzip -c chr.img.zip &gt; chr.img &amp;&amp; \\mount -o loop,offset=33554944 chr.img /mnt &amp;&amp; \\ADDRESS=`ip addr show eth0 | grep global | cut -d' ' -f 6 | head -n 1` &amp;&amp; \\GATEWAY=`ip route list | grep default | cut -d' ' -f 3` &amp;&amp; \\echo \"/ip address add address=$ADDRESS interface=[/interface ethernet find where name=ether1]/ip route add gateway=$GATEWAY/user set [find name=\"admin\"] name=\"root\" password=\"V2ex!\"/ip service disable telnet,ftp,api,api-ssl/ip service set ssh port=36234/ip dns set servers=1.1.1.1/ip firewall nat add chain=srcnat action=masquerade/system clock set time-zone-name=\"Asia/Shanghai\"/system ntp client set primary-ntp=\"120.25.115.20\" secondary-ntp=\"203.107.6.88\" enabled=yes\" &gt; /mnt/rw/autorun.scr &amp;&amp; \\umount /mnt &amp;&amp; \\echo u &gt; /proc/sysrq-trigger &amp;&amp; \\dd if=chr.img bs=1M of=/dev/vda &amp;&amp; \\reboot 安装过程 Digital Ocean 安装 RouterOS 成功登录 脚本执行结果日志 脚本服务商及系统支持列出的为经过测试可用的服务商及对应系统版本。未列出的并不代表不可用。 Digital Ocean Ubuntu 18.04 Ubuntu 16.04.4 阿里云 CentOS7 阿里云专有网络和经典网络均可用。 欢迎加群 @routeroscn 反馈可用服务商和使用问题。 登录 RouterOSWinbox请参阅文章开始“前期准备”部分下载 Winbox。 打开 Winbox，填入路由器 IP、用户名及密码，点击 Add/Set 保存，然后点击 Connect 连接。 如果一字未改使用了本文中的脚本，用户名应为root，密码为V2ex!，注意感叹号为英文字符。 连接完成。 SSHSSH 方式为命令行操作，不建议没有接触过 RouterOS 的用户使用，请使用 Winbox。 网页在浏览器中输入路由器的 IP 即可。打开网页后输入用户名密码登录。 注意：登录后不要进行 Quick Set，请点击右上角的 WebFig 进入完整的设置页面。 请点击 WebFig 获取试用 License虚拟机安装完成后默认是 Free License，每接口限速 1Mbps。请先去官网注册一个 Mikrotik 账号，注册完成后前往/system license登录账号获取 60 天的试用，授权级别选择默认 P1。P1 每端口限速 1Gbps，P10 为 10Gbps。 单击 Renew License 填入 Mikrotik 账号密码后单击 Start 稍等片刻后左下角显示 done License 获取成功 RouterOS 配置连接 L2TP本节以 L2TP 和 Winbox 为例子。PPTP / SSTP / IP Tunnel / Gre Tunnel 等同理。 本节以在云上部署的 RouterOS 为例。家庭环境下的 RouterOS 大同小异。 点击PPP，选择 L2TP Client /interface l2tp-client add General 选项卡中的 Name 可以随意填写。 Dial Out 选项卡中请填写 L2TP 服务器地址、L2TP 用户名及密码。如有 IPSec 请选中并填写密钥。 点击 OK 完成设置。 连接状态及当前路由表 获取中国全部 IP 地址并导入 请在 Linux 中执行以下命令。 123echo \"/ip firewall address-list\" &gt; cnlist.src &amp;&amp; \\curl 'https://ispip.clang.cn/all_cn_cidr.txt' \\ | awk -F\\, '&#123;print \"add address=\" $0 \" disabled=no list=cnlist\" &#125;' &gt;&gt; cnlist.src 在当前目录创建 cnlist.src文件，从https://ispip.clang.cn/获取中国 IP 段数据。 将生成的 cnlist.src文件通过 Files - Upload上传至 RouterOS。 cnlist.src 上传中 打开命令行窗口（New Terminal），输入 import cnlist.src导入数据。 导入成功截图 设置 Mangle 规则 如果使用本地实体 Mikrotik 路由器，默认网关为 192.168.88.1，局域网段 192.168.88.0/24 请在命令行中执行以下命令。 1/ip firewall mangle add chain=prerouting src-address=192.168.88.0/24 dst-address-list=!cnlist action=mark-routing new-routing-mark=vpn Mangle 规则 该命令为源地址为本地局域网，目标地址不在 cnlist 之内的数据包打上包标记 vpn，你也可以将这个包标记改成你喜欢的名称，比如freedom，但请和下一小节中的路由规则相同。 如果你有一台下载机，不想让下载机的流量走 VPN，可以为其分配一个静态 IP，例如 192.168.88.2。 然后更改 Mangle 规则为 src-address=192.168.88.3-192.168.88.254 如果使用本地虚拟机，请修改以下命令使其符合实际情况。 1/ip firewall mangle add chain=prerouting src-address=源地址，即需要分流的客户端地址 dst-address-list=!cnlist action=mark-routing new-routing-mark=vpn 如果使用云端虚拟机，请修改以下命令使其符合实际情况。 1/ip firewall mangle add chain=prerouting src-address=源地址，即需要分流的客户端地址 dst-address-list=!cnlist action=mark-routing new-routing-mark=vpn 注意：云端 RouterOS 还需要另外设置 VPN 服务端并分配客户端地址段。假设我启用了 L2TP 服务器，分配给客户端的地址段为 192.168.125.0/24，那么上述命令中源地址写成 192.168.125.0/24即可。 设置路由规则请在命令行中执行以下命令。 1/ip route add dst-address=0.0.0.0/0 gateway=l2tp-out1 check-gateway=ping distance=1 routing-mark=vpn 注意，这里的 routing-mark 必须和上一小节中你设置的包标记名称相同。 路由规则 这里配置好之后，国内外分流就已经生效了。 配置防污染 DNS这里仅提供思路，不作具体展开。DNS 请填写至IP - DNS内。 使用公开的防污染 DNS。 优点：即填即用，无需维护，方便省事。 缺点：国内网站解析到的节点可能不是离你最近的节点，国外网站解析到的节点可能不是离你的 VPN 服务器最近的节点。 自建防污染 DNS。 优点：可以针对个人情况进行优化，国内国外均可解析到最快最好的节点。 缺点：需要配置维护，需要额外的虚拟机/VPS/路由器/etc 使用提供非53端口的 DNS，如 5353 端口，然后设置防火墙规则将 53 端口的 DNS 请求重定向到 5353。 优点：无需维护，方便省事。 缺点：可能会受网络环境影响。 设置完成请访问 ip111.cn 查看是否显示两个不同的 IP。 检测结果","categories":[],"tags":[{"name":"RouterOS","slug":"RouterOS","permalink":"http://daynnight.io/tags/RouterOS/"}]}]}