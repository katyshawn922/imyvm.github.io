<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Dayn&#39;Night</title>
  
  <subtitle>深夜便利店</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://daynnight.io/"/>
  <updated>2018-08-23T02:48:46.196Z</updated>
  <id>http://daynnight.io/</id>
  
  <author>
    <name>Sconosciuti</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>RouterOS基于Layer7的Netflix智能分流</title>
    <link href="http://daynnight.io/posts/e0021cb6/"/>
    <id>http://daynnight.io/posts/e0021cb6/</id>
    <published>2018-08-23T02:49:24.000Z</published>
    <updated>2018-08-23T02:48:46.196Z</updated>
    
    <content type="html"><![CDATA[<h1 id="适用对象"><a href="#适用对象" class="headerlink" title="适用对象"></a>适用对象</h1><ul><li>有 <code>A, B</code>两条线路，A 延迟低速度快但不能看 Netflix，B 延迟高速度一般但可以看 Netflix。</li><li>有 <code>A, B</code>两条线路，A 流量多但不能看 Netflix，B 流量少可以看 Netflix。</li><li>我就是想看 A 区的限定内容，但我又不想全局走 A 的代理。</li><li>不折腾会死综合征。</li><li>……</li></ul><h2 id="本方案优点"><a href="#本方案优点" class="headerlink" title="本方案优点"></a>本方案优点</h2><ul><li><p><strong>精确识别 Netflix 的流量并路由至期望的线路。</strong></p><blockquote><p>使用 Layer 7 正则匹配。</p></blockquote></li><li><p><strong>无需更改本机 DNS。</strong></p><blockquote><p>改个 DNS 就能解锁流媒体服务？我就是不想改怎么办？</p></blockquote></li><li><p><strong>地址条目少，性能好。</strong></p><blockquote><p>相比导入全部 AWS IP 段的暴力做法更为优雅。只导入访问需要的地址条目且有效期过后自动移除。</p></blockquote></li><li><p><strong>使用时间越久，效果越好。</strong></p><blockquote><p>使用时间越久，精准导入的地址条目越多，下次打开 Netflix 分配的服务器 IP 命中率就越高，效果越好。有点像热力链，地址条目中的 IP 有有效期，当 IP 在有效期内被访问时，自动刷新有效期，有效期结束后自动移除。</p></blockquote></li></ul><h2 id="本方案缺点"><a href="#本方案缺点" class="headerlink" title="本方案缺点"></a>本方案缺点</h2><ul><li><p>刚设置完成后一段时间打开 Netflix 比较慢。</p><blockquote><p>假设现在有 <code>A</code>, <code>B</code>两条线路，<code>A</code> 为普通线路，<code>B</code> 可看 Netflix。</p><p>一开始设备访问 Netflix ，请求走的 <code>A</code> 线路，请求发出去之后 RouterOS 发现是 Netflix 的包，于是进行匹配并路由至 <code>B</code> 线路。</p><p>而源地址发生变化导致后续的包全部被丢弃了。</p><p><strong>解决办法</strong>是耐心<strong>等待数据包重传</strong>，大概十几二十秒就会打开。或者等个几秒让 RouterOS 添加好地址，直接<strong>关掉页面再开</strong>即可。</p><p>该情况<strong>仅发生</strong>在第一次打开 Netflix 网页时，后续如果一直看片不关闭网页不会有此现象。</p></blockquote></li><li><p>切换区域时打开 Netflix 比较慢。</p><blockquote><p>比如一直用美国线路看美区，有一天换成了香港线路看港区。港区 CDN 用的 PCCW，在美区获得的 <code>address-list</code> 并不适用于港区，需要重新识别并添加进地址列表。</p><p>该情况<strong>仅发生</strong>在换区后第一次打开 Netflix 网页时，后续如果一直看片不关闭网页不会有此现象。</p></blockquote></li><li><p><strong>You tell me!</strong></p></li></ul><h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><ul><li style="list-style: none"><input type="checkbox" checked> 已经按照 <a href="https://daynnight.io/posts/536e8593/">RouterOS基于目标地址的国内外分流</a> 配置完成。</li><li style="list-style: none"><input type="checkbox" checked> 可用的 Netflix 账号。</li><li style="list-style: none"><input type="checkbox" checked> 加入 Telegram 群 <a href="https://telegram.me/routeroscn" target="_blank" rel="noopener">@[CN] RouterOS 交流群</a></li></ul><h1 id="RouterOS-配置"><a href="#RouterOS-配置" class="headerlink" title="RouterOS 配置"></a>RouterOS 配置</h1><h2 id="获取-Netflix-IP-段"><a href="#获取-Netflix-IP-段" class="headerlink" title="获取 Netflix IP 段"></a>获取 Netflix IP 段</h2><blockquote><p>限于技术水平，这里采用的方法可能不是最佳实践，有更好用的 IP 来源或更好的处理方式请联系<a href="https://telegram.me/sconosciuti" target="_blank" rel="noopener">我</a>。</p></blockquote><ul><li><p>在 <code>bgp.he.net</code> 搜索 Netflix 的 IP 段。<a href="https://bgp.he.net/search?search%5Bsearch%5D=netflix&amp;commit=Search" target="_blank" rel="noopener">一键直达</a></p></li><li><p>全选并复制整个页面的内容，粘贴并保存为文本文件，例如<code>netflixraw.txt</code>。</p></li><li><p>在 Linux 上安装 <strong>Aggregate</strong>，一个合并 IP 段的工具。</p><blockquote><p>Optimise a list of route prefixes to help make nice short filters.</p></blockquote><ul><li><p><strong>Debian, Ubuntu</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install aggregate</span><br></pre></td></tr></table></figure></li><li><p><strong>Redhat, CentOS, Fedora</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install aggregate</span><br></pre></td></tr></table></figure></li></ul></li><li><p>安装完成后执行以下命令，请确认 <code>netflixraw.txt</code> 在当前目录。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"/ip firewall address-list"</span> &gt; netflix.src &amp;&amp; \</span><br><span class="line">egrep -o <span class="string">'^([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;(\/([0-9]|[1-2][0-9]|3[0-2]))'</span> netflixraw.txt \</span><br><span class="line">| aggregate -q | sort -n \</span><br><span class="line">| awk -F\, <span class="string">'&#123;print "add address=" $0 " disabled=no list=netflix" &#125;'</span> &gt;&gt; netflix.src</span><br></pre></td></tr></table></figure><ul><li><blockquote><p><code>egrep</code> 正则匹配 IP 段，<code>aggregate</code> 对输出的 IP 段进行合并优化，<code>sort</code> 将结果排序，<code>awk</code> 输出结果到文件。</p></blockquote></li><li><p>将<code>netflix.src</code> 文件导入至 RouterOS 即可。<strong>懒得动手操作的可以直接复制粘贴下面的。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/ip firewall address-list</span><br><span class="line">add address=23.246.0.0/18 disabled=no list=netflix</span><br><span class="line">add address=37.77.184.0/21 disabled=no list=netflix</span><br><span class="line">add address=45.57.0.0/17 disabled=no list=netflix</span><br><span class="line">add address=64.120.128.0/17 disabled=no list=netflix</span><br><span class="line">add address=66.197.128.0/17 disabled=no list=netflix</span><br><span class="line">add address=69.53.224.0/19 disabled=no list=netflix</span><br><span class="line">add address=103.87.204.0/22 disabled=no list=netflix</span><br><span class="line">add address=108.175.32.0/20 disabled=no list=netflix</span><br><span class="line">add address=179.49.23.0/24 disabled=no list=netflix</span><br><span class="line">add address=185.2.220.0/22 disabled=no list=netflix</span><br><span class="line">add address=185.9.188.0/22 disabled=no list=netflix</span><br><span class="line">add address=192.173.64.0/18 disabled=no list=netflix</span><br><span class="line">add address=198.38.96.0/19 disabled=no list=netflix</span><br><span class="line">add address=198.45.48.0/20 disabled=no list=netflix</span><br><span class="line">add address=207.45.72.0/22 disabled=no list=netflix</span><br><span class="line">add address=208.75.76.0/24 disabled=no list=netflix</span><br></pre></td></tr></table></figure><blockquote><p>数据抓取时间：2018/08/23 07:43</p></blockquote></li></ul><h2 id="设置-Layer-7-规则"><a href="#设置-Layer-7-规则" class="headerlink" title="设置 Layer 7 规则"></a>设置 Layer 7 规则</h2><p><strong>请在 RouterOS 的命令行中执行以下命令。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ip firewall layer7-protocol add name=&quot;netflix&quot; \</span><br><span class="line">regexp=&quot;netflix.com|nflxext.com|nflxvideo.net|nflxso.net|nflximg.net|netflix.net|netflixdnstest[0-9].com&quot;</span><br></pre></td></tr></table></figure><blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/23/5b7e04007df28.png" alt="Netflix L7 匹配规则" title="">                </div>                <div class="image-caption">Netflix L7 匹配规则</div>            </figure></blockquote><h2 id="设置-Mangle-规则"><a href="#设置-Mangle-规则" class="headerlink" title="设置 Mangle 规则"></a>设置 Mangle 规则</h2><h3 id="自动添加-Netflix-IP-地址"><a href="#自动添加-Netflix-IP-地址" class="headerlink" title="自动添加 Netflix IP 地址"></a>自动添加 Netflix IP 地址</h3><p><strong>请在 RouterOS 的命令行中执行以下命令。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/ip firewall mangle add chain=prerouting src-address=&quot;需要分流的客户端地址&quot; \</span><br><span class="line">protocol=tcp dst-port=443 layer7-protocol=netflix \</span><br><span class="line">action=add-dst-to-address-list address-list=netflix address-list-timeout=90d</span><br></pre></td></tr></table></figure><blockquote><p>这里解释下 <code>address-list-timeout</code> 这个参数。</p><p>引自 Wiki：如果未指定该参数，则该地址将永久保存到硬盘中。如果指定了该参数，则地址将存储在内存中，并在系统重启后删除。</p><p>意思就是断电或手动重启后这些地址就会丢失。如果喜欢天天定时重启路由或家里经常断电的话……将这个参数设成 <code>address-list-timeout=none-static</code> 即可。后果是地址列表会慢慢变大不会缩小。</p></blockquote><blockquote><p>这个值<strong>建议</strong> <code>7d</code> 以上，这样命中地址条目的概率比较大。</p></blockquote><h3 id="为-Netflix-流量打上路由标记"><a href="#为-Netflix-流量打上路由标记" class="headerlink" title="为 Netflix 流量打上路由标记"></a>为 Netflix 流量打上路由标记</h3><p><strong>请在 RouterOS 的命令行中执行以下命令。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ip firewall mangle add chain=prerouting src-address=&quot;需要分流的客户端地址&quot; dst-address-list=netflix action=mark-routing new-routing-mark=nfvpn</span><br></pre></td></tr></table></figure><blockquote><p>最后一个参数 <code>new-routing-mark</code> 路由标记可以设成自己喜欢的，这里命名为 <code>nfvpn</code></p></blockquote><h2 id="设置路由规则"><a href="#设置路由规则" class="headerlink" title="设置路由规则"></a>设置路由规则</h2><p><strong>请在 RouterOS 的命令行中执行以下命令。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ip route add dst-address=0.0.0.0/0 gateway=&quot;可看 Netflix 的接口&quot; check-gateway=ping distance=1 routing-mark=nfvpn</span><br></pre></td></tr></table></figure><blockquote><p>参数 <code>routing-mark</code> 请和上方 <code>new-routing-mark</code> 的值相同。</p></blockquote><h2 id="设置完成"><a href="#设置完成" class="headerlink" title="设置完成"></a>设置完成</h2><p>效果图如下。有效期我设置了 7 天。</p><p>有新增 IP 的时候打开速度会慢一点，只要进了地址列表，速度立马就上来了。</p><blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/23/5b7e1c0621722.png" alt="address list 截图对比" title="">                </div>                <div class="image-caption">address list 截图对比</div>            </figure></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;适用对象&quot;&gt;&lt;a href=&quot;#适用对象&quot; class=&quot;headerlink&quot; title=&quot;适用对象&quot;&gt;&lt;/a&gt;适用对象&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;有 &lt;code&gt;A, B&lt;/code&gt;两条线路，A 延迟低速度快但不能看 Netflix，B 延迟高速度一般但可
      
    
    </summary>
    
    
      <category term="RouterOS" scheme="http://daynnight.io/tags/RouterOS/"/>
    
  </entry>
  
  <entry>
    <title>RouterOS基于目标地址的国内外分流</title>
    <link href="http://daynnight.io/posts/536e8593/"/>
    <id>http://daynnight.io/posts/536e8593/</id>
    <published>2018-08-21T08:59:06.000Z</published>
    <updated>2018-08-22T22:47:14.032Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><h2 id="硬件"><a href="#硬件" class="headerlink" title="硬件"></a>硬件</h2><ul><li><strong>Mikrotik 路由器</strong> × 1 –&gt; 请配置完能上网之后直接阅读<strong>RouterOS 配置</strong>部分</li><li>或 RouterOS 虚拟机 × 1 –&gt; 请完整阅读</li></ul><h2 id="软件"><a href="#软件" class="headerlink" title="软件"></a>软件</h2><ul><li>可用的 L2TP / PPTP / SSTP 账号 × 1</li><li>Winbox <a href="https://download.mikrotik.com/routeros/winbox/3.17/winbox.exe" target="_blank" rel="noopener">点此下载 v3.17</a> (Windows 平台，用于登录并管理 RouterOS。macOS 和 Linux 需要使用 Wine 或虚拟机)</li></ul><p><strong>推荐</strong> L2TP over IPSec。</p><h2 id="Telegram"><a href="#Telegram" class="headerlink" title="Telegram"></a>Telegram</h2><p>加群 <a href="https://telegram.me/routeroscn" target="_blank" rel="noopener">@routeroscn</a> 以获得群内各路大佬的帮助。</p><h1 id="RouterOS-安装"><a href="#RouterOS-安装" class="headerlink" title="RouterOS 安装"></a>RouterOS 安装</h1><h2 id="本地"><a href="#本地" class="headerlink" title="本地"></a>本地</h2><p><strong>VMWare / VMWare ESXi</strong>: <a href="https://wiki.mikrotik.com/wiki/Manual:CHR_VMWare_installation" target="_blank" rel="noopener">https://wiki.mikrotik.com/wiki/Manual:CHR_VMWare_installation</a></p><p><strong>Hyper-V</strong>: <a href="https://wiki.mikrotik.com/wiki/Manual:CHR_Hyper-V_installation" target="_blank" rel="noopener">https://wiki.mikrotik.com/wiki/Manual:CHR_Hyper-V_installation</a></p><p><strong>VirtualBox</strong>: <a href="https://wiki.mikrotik.com/wiki/Manual:CHR_VirtualBox_installation" target="_blank" rel="noopener">https://wiki.mikrotik.com/wiki/Manual:CHR_VirtualBox_installation</a></p><p><strong>ProxMox</strong>: <a href="https://wiki.mikrotik.com/wiki/Manual:CHR_ProxMox_installation" target="_blank" rel="noopener">https://wiki.mikrotik.com/wiki/Manual:CHR_ProxMox_installation</a></p><h2 id="云"><a href="#云" class="headerlink" title="云"></a>云</h2><h3 id="安装脚本"><a href="#安装脚本" class="headerlink" title="安装脚本"></a>安装脚本</h3><h4 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h4><ul><li>设置默认网关、路由（如果接口名称非 <code>eth0</code> 请手动更改脚本第 4 行）</li><li>更改默认用户名及密码防止被空密码登录</li><li>禁用 Telnet、FTP 及 API 端口</li><li>更改 SSH 默认端口</li><li>设置 DNS 服务器为 <code>1.1.1.1</code></li><li>设置 NAT 规则</li><li>设定时区及 NTP 对时（使用 <code>ntp1.aliyun.com</code>及 <code>ntp2.aliyun.com</code>，值需为 IP 形式）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">wget https://download2.mikrotik.com/routeros/6.42.7/chr-6.42.7.img.zip -O chr.img.zip &amp;&amp; \</span><br><span class="line">gunzip -c chr.img.zip &gt; chr.img &amp;&amp; \</span><br><span class="line">mount -o loop,offset=33554944 chr.img /mnt &amp;&amp; \</span><br><span class="line">ADDRESS=`ip addr show eth0 | grep global | cut -d<span class="string">' '</span> -f 6 | head -n 1` &amp;&amp; \</span><br><span class="line">GATEWAY=`ip route list | grep default | cut -d<span class="string">' '</span> -f 3` &amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/ip address add address=<span class="variable">$ADDRESS</span> interface=[/interface ethernet find where name=ether1]</span></span><br><span class="line"><span class="string">/ip route add gateway=<span class="variable">$GATEWAY</span></span></span><br><span class="line"><span class="string">/user set [find name="</span>admin<span class="string">"] name="</span>root<span class="string">" password="</span>V2ex!<span class="string">"</span></span><br><span class="line"><span class="string">/ip service disable telnet,ftp,api,api-ssl</span></span><br><span class="line"><span class="string">/ip service set ssh port=36234</span></span><br><span class="line"><span class="string">/ip dns set servers=1.1.1.1</span></span><br><span class="line"><span class="string">/ip firewall nat add chain=srcnat action=masquerade</span></span><br><span class="line"><span class="string">/system clock set time-zone-name="</span>Asia/Shanghai<span class="string">"</span></span><br><span class="line"><span class="string">/system ntp client set primary-ntp="</span>120.25.115.20<span class="string">" secondary-ntp="</span>203.107.6.88<span class="string">" enabled=yes</span></span><br><span class="line"><span class="string">"</span> &gt; /mnt/rw/autorun.scr &amp;&amp; \</span><br><span class="line">umount /mnt &amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> u &gt; /proc/sysrq-trigger &amp;&amp; \</span><br><span class="line">dd <span class="keyword">if</span>=chr.img bs=1M of=/dev/vda &amp;&amp; \</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><h4 id="安装过程"><a href="#安装过程" class="headerlink" title="安装过程"></a>安装过程</h4><blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/20/5b7a9968889e3.png" alt="Digital Ocean 安装 RouterOS" title="">                </div>                <div class="image-caption">Digital Ocean 安装 RouterOS</div>            </figure></blockquote><blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/20/5b7a9e0ac07e8.png" alt="成功登录 脚本执行结果日志" title="">                </div>                <div class="image-caption">成功登录 脚本执行结果日志</div>            </figure></blockquote><h4 id="脚本服务商及系统支持"><a href="#脚本服务商及系统支持" class="headerlink" title="脚本服务商及系统支持"></a>脚本服务商及系统支持</h4><p>列出的为经过测试可用的服务商及对应系统版本。<strong>未列出的并不代表不可用</strong>。</p><h5 id="Digital-Ocean"><a href="#Digital-Ocean" class="headerlink" title="Digital Ocean"></a>Digital Ocean</h5><ul><li>Ubuntu 18.04</li><li>Ubuntu 16.04.4</li></ul><h5 id="阿里云"><a href="#阿里云" class="headerlink" title="阿里云"></a>阿里云</h5><ul><li>CentOS7</li></ul><blockquote><p>阿里云专有网络和经典网络均可用。</p></blockquote><p>欢迎加群 <a href="https://telegram.me/routeroscn" target="_blank" rel="noopener">@routeroscn</a> 反馈可用服务商和使用问题。</p><h2 id="登录-RouterOS"><a href="#登录-RouterOS" class="headerlink" title="登录 RouterOS"></a>登录 RouterOS</h2><h3 id="Winbox"><a href="#Winbox" class="headerlink" title="Winbox"></a>Winbox</h3><p>请参阅文章开始“<strong>前期准备</strong>”部分下载 Winbox。</p><ul><li><p>打开 Winbox，填入路由器 IP、用户名及密码，点击 Add/Set 保存，然后点击 Connect 连接。</p><blockquote><p>如果一字未改使用了本文中的脚本，用户名应为<code>root</code>，密码为<code>V2ex!</code>，注意感叹号为英文字符。</p></blockquote></li><li><p>连接完成。</p></li></ul><h3 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h3><p>SSH 方式为命令行操作，不建议没有接触过 RouterOS 的用户使用，请使用 Winbox。</p><h3 id="网页"><a href="#网页" class="headerlink" title="网页"></a>网页</h3><p>在浏览器中输入路由器的 IP 即可。打开网页后输入用户名密码登录。</p><p><strong>注意：登录后不要进行 Quick Set，请点击右上角的 WebFig 进入完整的设置页面。</strong></p><blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/20/5b7aa6952bc4c.png" alt="请点击 WebFig" title="">                </div>                <div class="image-caption">请点击 WebFig</div>            </figure></blockquote><h2 id="获取试用-License"><a href="#获取试用-License" class="headerlink" title="获取试用 License"></a>获取试用 License</h2><p>虚拟机安装完成后默认是 Free License，每接口限速 1Mbps。请先去<a href="https://mikrotik.com/client/register" target="_blank" rel="noopener">官网</a>注册一个 Mikrotik 账号，注册完成后前往<code>/system license</code>登录账号获取 60 天的试用，授权级别选择默认 P1。P1 每端口限速 1Gbps，P10 为 10Gbps。</p><blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/20/5b7aa147a94b8.png" alt="单击 Renew License" title="">                </div>                <div class="image-caption">单击 Renew License</div>            </figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/20/5b7aa147d66fa.png" alt="填入 Mikrotik 账号密码后单击 Start" title="">                </div>                <div class="image-caption">填入 Mikrotik 账号密码后单击 Start</div>            </figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/20/5b7aa1490a32e.png" alt="稍等片刻后左下角显示 done" title="">                </div>                <div class="image-caption">稍等片刻后左下角显示 done</div>            </figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/20/5b7aa14935408.png" alt="License 获取成功" title="">                </div>                <div class="image-caption">License 获取成功</div>            </figure></blockquote><h1 id="RouterOS-配置"><a href="#RouterOS-配置" class="headerlink" title="RouterOS 配置"></a>RouterOS 配置</h1><h2 id="连接-L2TP"><a href="#连接-L2TP" class="headerlink" title="连接 L2TP"></a>连接 L2TP</h2><p>本节以 L2TP 和 Winbox 为例子。PPTP / SSTP / IP Tunnel / Gre Tunnel 等同理。</p><p>本节截图以<strong>在云上部署的 RouterOS 为例</strong>。家庭环境下的 RouterOS 大同小异。</p><ul><li>点击<code>PPP</code>，选择 <code>L2TP Client</code></li></ul><blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/20/5b7aaa3431c43.png" alt="/interface l2tp-client add" title="">                </div>                <div class="image-caption">/interface l2tp-client add</div>            </figure></blockquote><ul><li><code>General</code> 选项卡中的 Name 可以随意填写。</li><li><code>Dial Out</code> 选项卡中请填写 L2TP 服务器地址、L2TP 用户名及密码。如有 IPSec 请选中并填写密钥。</li><li>点击 <code>OK</code> 完成设置。</li></ul><blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/20/5b7aac8de7157.png" alt="连接状态及当前路由表" title="">                </div>                <div class="image-caption">连接状态及当前路由表</div>            </figure></blockquote><h2 id="获取中国全部-IP-地址并导入"><a href="#获取中国全部-IP-地址并导入" class="headerlink" title="获取中国全部 IP 地址并导入"></a>获取中国全部 IP 地址并导入</h2><ul><li>请在 Linux 中执行以下命令。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"/ip firewall address-list"</span> &gt; cnlist.src &amp;&amp; \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"remove [find name=cnlist]"</span> &gt;&gt; cnlist.src &amp;&amp; \</span><br><span class="line">curl <span class="string">'https://ispip.clang.cn/all_cn_cidr.txt'</span> \</span><br><span class="line">  | awk -F\, <span class="string">'&#123;print "add address=" $0 " disabled=no list=cnlist" &#125;'</span> &gt;&gt; cnlist.src</span><br></pre></td></tr></table></figure><blockquote><p>在当前目录创建 <code>cnlist.src</code>文件，从<code>https://ispip.clang.cn/</code>获取中国 IP 段数据并写入。</p><p>因 IP 数据是一直在变动的，建议至少一年更新一次数据，即执行上述命令并导入到 RouterOS。</p><p>导入时 CPU 占用可能会瞬间飙升至 100%。</p></blockquote><ul><li><p>将生成的 <code>cnlist.src</code>文件通过 <code>Files - Upload</code>上传至 RouterOS。</p><p><del>你要是觉得麻烦，也可以直接复制<code>cnlist.src</code>的文件内容，打开 RouterOS 的命令行粘贴进去。然后就可以欣赏像瀑布一样的 Terminal 了。</del></p></li></ul><blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/21/5b7b8591c58e0.png" alt="cnlist.src 上传中" title="">                </div>                <div class="image-caption">cnlist.src 上传中</div>            </figure></blockquote><ul><li>打开命令行窗口（New Terminal），输入 <code>import cnlist.src</code>导入数据。</li></ul><blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/21/5b7b851f440de.png" alt="导入成功截图" title="">                </div>                <div class="image-caption">导入成功截图</div>            </figure></blockquote><h2 id="设置-Mangle-规则"><a href="#设置-Mangle-规则" class="headerlink" title="设置 Mangle 规则"></a>设置 Mangle 规则</h2><ul><li><p>如果使用<strong>本地实体 Mikrotik 路由器</strong>，默认网关为 <code>192.168.88.1</code>，局域网段 <code>192.168.88.0/24</code></p><p>请在命令行中执行以下命令。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ip firewall mangle add chain=prerouting src-address=192.168.88.0/24 dst-address-list=!cnlist action=mark-routing new-routing-mark=vpn</span><br></pre></td></tr></table></figure><blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/21/5b7b8f85cf697.png" alt="Mangle 规则" title="">                </div>                <div class="image-caption">Mangle 规则</div>            </figure></blockquote><p>该命令为源地址为本地局域网，目标地址不在 cnlist 之内的数据包打上包标记 <code>vpn</code>，你也可以将这个包标记改成你喜欢的名称，比如<code>freedom</code>，但<strong>请和下一小节中的路由规则相同</strong>。</p><blockquote><p>如果你有一台下载机，不想让下载机的流量走 VPN，可以为其分配一个静态 IP，例如 <code>192.168.88.2</code>。</p><p>然后更改 Mangle 规则为 <code>src-address=192.168.88.3-192.168.88.254</code></p></blockquote></li><li><p>如果使用<strong>本地虚拟机</strong>，请修改以下命令使其符合实际情况。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ip firewall mangle add chain=prerouting src-address=源地址，即需要分流的客户端地址 dst-address-list=!cnlist action=mark-routing new-routing-mark=vpn</span><br></pre></td></tr></table></figure></li><li><p>如果使用<strong>云端虚拟机</strong>，请修改以下命令使其符合实际情况。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ip firewall mangle add chain=prerouting src-address=源地址，即需要分流的客户端地址 dst-address-list=!cnlist action=mark-routing new-routing-mark=vpn</span><br></pre></td></tr></table></figure><blockquote><p>注意：云端 RouterOS 还需要另外设置 VPN 服务端并分配客户端地址段。假设我启用了 L2TP 服务器，分配给客户端的地址段为 <code>192.168.125.0/24</code>，那么上述命令中源地址写成 <code>192.168.125.0/24</code>即可。</p></blockquote><blockquote><p>如果使用 Gre Tunnel / IP Tunnel ，源地址填写另一端的网段。</p></blockquote></li></ul><h2 id="设置路由规则"><a href="#设置路由规则" class="headerlink" title="设置路由规则"></a>设置路由规则</h2><p>请在命令行中执行以下命令。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ip route add dst-address=0.0.0.0/0 gateway=l2tp-out1 check-gateway=ping distance=1 routing-mark=vpn</span><br></pre></td></tr></table></figure><blockquote><p>注意，这里的 <code>routing-mark</code> 必须和上一小节中你设置的包标记名称相同。</p></blockquote><blockquote><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/21/5b7b8f85d16d4.png" alt="路由规则" title="">                </div>                <div class="image-caption">路由规则</div>            </figure></blockquote><p>这里配置好之后，国内外分流就已经生效了。</p><h2 id="配置防污染-DNS"><a href="#配置防污染-DNS" class="headerlink" title="配置防污染 DNS"></a>配置防污染 DNS</h2><p>这里仅提供思路，不作具体展开。DNS 请填写至<code>IP - DNS</code>内。</p><ul><li>使用公开的防污染 DNS。<ul><li>优点：即填即用，无需维护，方便省事。</li><li>缺点：国内网站解析到的节点可能不是离你最近的节点，国外网站解析到的节点可能不是离你的 VPN 服务器最近的节点。简而言之就是速度和延迟不理想。</li></ul></li><li>自建防污染 DNS。<ul><li>优点：可以针对个人情况进行优化，国内国外均可解析到最快最好的节点。</li><li>缺点：需要配置维护，需要额外的虚拟机/VPS/路由器/etc</li></ul></li><li>使用提供非<code>53</code>端口的 DNS，如 <code>5353</code> 端口，然后设置防火墙规则将 53 端口的 DNS 请求重定向到 5353。<ul><li>优点：无需维护，方便省事。</li><li>缺点：可能会受网络环境影响。</li></ul></li><li>使用<code>1.1.1.1</code>等 DNS，并设置防火墙规则重定向 DNS 请求走 VPN。（dst-nat）<ul><li>优点：同上。</li><li>缺点：VPN 掉线后 DNS 也随之挂掉。（可以设置脚本监控 VPN 接口状态，掉线后自动切换 DNS 服务器和相关防火墙规则）</li></ul></li></ul><h2 id="设置完成"><a href="#设置完成" class="headerlink" title="设置完成"></a>设置完成</h2><p>请访问 <a href="http://ip111.cn" target="_blank" rel="noopener">ip111.cn</a> 查看是否显示两个不同的 IP。</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://i.loli.net/2018/08/21/5b7b90ea920e4.png" alt="检测结果" title="">                </div>                <div class="image-caption">检测结果</div>            </figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前期准备&quot;&gt;&lt;a href=&quot;#前期准备&quot; class=&quot;headerlink&quot; title=&quot;前期准备&quot;&gt;&lt;/a&gt;前期准备&lt;/h1&gt;&lt;h2 id=&quot;硬件&quot;&gt;&lt;a href=&quot;#硬件&quot; class=&quot;headerlink&quot; title=&quot;硬件&quot;&gt;&lt;/a&gt;硬件&lt;/h
      
    
    </summary>
    
    
      <category term="RouterOS" scheme="http://daynnight.io/tags/RouterOS/"/>
    
  </entry>
  
</feed>
